Бизнес-процесс запускается при добавлении email Обращения

Читается Контакт из Обращения и происходит проверка Контакта на спам по следующем принципам
1. В Контакте поле "Тип" имеет значение "Клиент не определен/Спам"
2. В системной настройке "OLP: Этап 1" выставлено значение "false"

Если Контакт подходит под описание, то нужно *Выставить 1 линию поддержки 
с полем "Категория" установленном на значение "Новая командировка/Изменение командировки"
После чего Бизнес-процесс завершается

Если же Контакт не спам, то мы получаем данные email-а (Заголовок, тело, кому, копии и т.п) 
из объекта родительской Активности и выполняем следующие действия
1. Достаем за базы данных все ОСНОВНЫЕ и ДЕЖУРНЫЕ группы обслуживания
2. На основе полей "Кому" и "Копии" в email-е отбираем подходящие ОСНОВНЫЕ и ДЕЖУРНЫЕ группы обслуживания 

Далее мы получаем email "Адрес" и "Домен" из объекта Контакт
Делаем проверку на наличие в заголовке строк "TRAVEL-" или "ЗАЯВКА ПО РЕЛОКАЦИИ_"
Первая указывает на заявку от компании Яндекс, вторая от Сибур, которые обрабатываются отдельно
В Обращение устанавливаем поле "Номер TRAVEL" или "Релокация - СИБУР" (В зависимости от темы письма) 
на "Номер темы", которую вытаскиваем из "Заголовка" письма

После чего мы проверяем заполнены ли поля "Компания" и "Тип" в объекте Контакт
Если "Компания" указана, а "Тип" Контакта "Сотрудник" или "Поставщик" и системная настройка "OLP: Этап 1" не установлена
    *Выставить 1 линию поддержки с полем "Категория" установленном на значение "Сотрудник/Поставщик"
    После чего Бизнес-процесс завершается

Если ни "Компания", ни "Тип" не указаны
    Тогда пробуем найти домен Контакта среди доменов компании или среди почт компании. Делаем мы это так
    Достаем за базы данных Контрагента из объект "Средство связи контрагента" по следующим фильтрам
    1. В колонках "Тип" значение "Почтовый домен", а в "Номер" значение "Домен email" из объекта Контакт
    Или
    2. В колонках "Тип" значение "Email", а в "Номер" значение "Адрес" email-а из объекта Контакт
    После чего получаем поля "Тип" и "Холдинг" Контрагента из соответствующего объекта

    Проверяем найдена ли компания по домену контакта
    Если удалось найти Контрагента, у которого в поле "Тип" значение "Поставщик" или "Наша компания"
        Устанавливаем в поля Контакта "Тип" и "Компанию" значения Контрагента и 
        "Поставщик" или "Сотрудник", соответственно
        Так же, если не установлена системная настройка "OLP: Этап 1", то нужно 
            *Выставить 1 линию поддержки и завершить Бизнес-процесс
        Далее логика из этой части будет описана ниже в **Переход 2
    
    Если Компания или холдинг найдены, то выполняем логику описанную ниже в **Переход 1

Если установлена системная настройка "OLP: Этап 1" и "Тип" Контакта "Сотрудник" или "Поставщик"
    Запоминаем, что "Категорию обращение" в последствии будет установлена как "Сотрудник/Поставщик"
    После чего выполняем логику описанную ниже в **Переход 2

Если "Компания" указана и "Тип" Контакта "Клиент" или "Клиент не определен", то выполняем логику описанную ниже в **Переход 1

**Переход 1 (ЕИС - поиск контакта по Ид./Email/Телефону 1)
Выполняем запрос сервис ЕИС - поиск контакта по Ид./Email/Телефону по методу Поиск контакта по Ид./Email/телефону
передавая параметр "Адрес" email-а Контакта.

Проверяем найден ли Контакт в ЕИС
Если пришел НЕ успешный ответ от ЕИС, но Контрагент пустой и "Тип" Контакта пустой или "Клиент не определен/Спам"
    Категория обращения будет помечена как "Клиент не определен/Спам"
    Установка в объекте Контакт полей "Компания" и "Тип" на "OLP:AC Компания - не определена" и "Клиент не определен/Спам"
    
    Далее, Если системная настройка "OLP: Этап 1" не установлена
    то *Выставить 1 линию поддержки с "Категория обращения" как "Клиент не определен/Спам" и завершить Бизнес-процесс
    
    Eсли же установлена системная настройка "OLP: Этап 1", то
    установить в объекте Обращение полей "Категория", "Важность" и "Срочность"
    на "Клиент не определен/Спам", "Не важно" и "Не срочно"
    
    Последующая логика описана ниже в **Переход 2 

Если просто пришел успешный ответ от ЕИС или пришел успешный ответ от ЕИС и поле "Подтвержден в БД АК" Контакта установлено
    Получаем поля "Пилот" и "Холдинг" из объекта Контрагент, 
    у которого "Внешний Ид.БД АК" совпадает с "CompanyId" пришедшего из ЕИС

    Далее, для каждого email-а из списка email-ов, пришедших от ЕИС
        Выполняем запрос в базу данных по объекту "Средство связи контакта", у которого выставлены фильтры
        1. Поле "Contact" совпадает с Контактом
        2. Поле "Number" совпадает с "Адресом" email-а
        3. Поле "CommunicationType" или же тип связи выставлен как "Email"

        Если такого объекта нет, то добавляем его с вышеперечисленными полями

    То же самое действия проделываем с телефонами, пришедшими от ЕИС, заменяя параметр тип связи на "Phone"

    Обновляем данные Контакта

    Устанавливаем параметр "Ид. Холдинга компании клиента" на Контрагента для последующей установки параметра

    Последующая логика описана ниже в **Переход 3

Во всех остальных случаях
    Проверяем есть ли уже Компания
    Если Компания не установлена 
        Обновляем объект Контакт, устанавливая "Тип" на "Клиент", "Email" на "email" Контакта и "Компания" на "Контрагента"    
    Если Компания установлена 
        Обновляем объект Контакт, устанавливая "Тип" на "Клиент" и "Email" на "email" Контакта
    Последующая логика описана ниже в **Переход 2

**Переход 2 (Найти данные компании привязанной к контакту ненайденного в ЕИС)
Считываем объект Контрагент, у которого поле "Id" совпадает с объектом Обращение
После чего выставляем "Ид. Холдинга компании клиента" как "Холдинг" из объекта Контрагент
Последующая логика описана ниже в **Переход 3

**Переход 3 Чтение карточки контакта после обновления
Чтение объект Контакта после обновления данных
Выставляем в контекста процесса (Запоминяем для последующей установки в объект) параметры 
"Клиент ВИП платформа" на "Признак ВИП платформы",
"Признак ВИП" на "Признак ВИП",
"Ид. Компании клиента" на "Компания",
а так же в объект родительскую Активность выставляем "Контрагента" на "Компания" (Все параметры берем у Контакта)

Делаем запрос в бд по объекту "Группы обслуживания", добавляя следующие фильтры, 
если у Контакта не установлен параметр "ВИП платформа"
"Тип группы", указав выборку по "Основная группа"
"Почтовый ящик", указав выборку по "Почтовый ящик для регистрации обращений"
А так же сделать выборку "Компания" у контакта или "Холдинг" у Контрагента по параметру
"Компании" у объекта "Компании в группе обслуживания"
Если же у Контакта "ВИП платформа" установлена, то только добавить фильтр "Тип группы" на "ВИП Платформа" 

Далее для каджого элемента получившейся коллекции добавляем в список "Коллекция групп обслуживания"
новый элеметр у которого буду установлены параметры "Ид. Компании клиента" и "График работы", которые берем из ГО
Если нет ни одной подходящей ГО, установить параметр "Дежурную группу"

После чего идет проверка найдена ли группа по компании ВИП Платформа
Если не установлены параметр "Дежурная группа" и системная настройка "OLP: Этап 1"
    *Найти ГО основную по графику работы
    Далее логика описывается в **Переход 4

Если группа по компании ВИП Платформа не найдена, то 
    сразу переходим к логике в **Переход 4

Если установлена системная настройка "OLP: Этап 1"
    *Найти ГО основную по графику работы
    
    Какую ГО установить?
    Если установлены "Ид. экстра группы из кому/копии" и "Дежурная группа", а 
    "Ид. основной группы по почтовому ящику" не стоит
        Далее логика описывается в **Переход 5

    Если не установлена "Дежурная группа"
        (Отправить автоответ - не пишите на бук)
        В Активности установить поле Автоматическое уведомление
        Последующая логика описывается в **Переход 6

    Если установлены "Ид. основной группы по почтовому ящику" и "Дежурная группа"
        Если указаны "Ид. экстра группы из кому/копии" и "Дежурная группа"
            Далее логика описывается в **Переход 5

        Если установлена "Ид. выбранной ГО" и не стоит "Дежурная группа"
            Последующая логика описывается в **Переход 6

        Если не подходит осн по компании и та что указана в почте и нет дежурной в копии
            (Найти ГО дежурную по графику работы) вредо как по *Найти ГО основную по графику работы 

            Если не установлено "Ид. выбранной ГО" и
            Указана "Дежурная группа" или не указана и "Email" Контакта содержит "NOREPLY@" или "NO-REPLY@" или "EDM@npk.team"
                Последующая логика описывается в **Переход 6

            Если не установлена "Дежурная группа" и "Email" Контакта не содержит "NOREPLY@" или "NO-REPLY@" или "EDM@npk.team"
                Отправить автоответ на букинг
                В Активности установить поле Автоматическое уведомление
                Последующая логика описывается в **Переход 6

    В противном случае **Переход 7

**Переход 4 (Какая ГО должна быть у контакта?)
Если установлены параметры "Дежурная группа" и "Клиент ВИП", то 
    установить в "Ид. выбранной ГО" значение "OLP:ГО Дежурная группа" и **Переход 5

Если не стоит "Дежурная группа", то **Переход 5

Если установлен параметр "Дежурная группа", но не "Клиент ВИП"
    установить в "Ид. выбранной ГО" значение "OLP:ГО Общая 1 линия поддержки"
    *Добавить 1 линия поддержки на обр
    **Переход 7

**Переход 5 (Найти ГО дежурную из кому/копии по графику работы)
(Найти ГО дежурную из кому/копии по графику работы) Похоже на *Найти ГО основную по графику работы с заменой "Основной", а "Дежурную"

Если Дежурная ГО найдена, то **Переход 6

Если Дежурной ГО нет
    *Найти основную ГО для контакта по компаниям
    Если Дежурной ГО нет
        То установить "Ид. выбранной ГО" на "Ид. экстра группы из кому/копии"
    (Отправить автоответ - не пишите на бук)
    В Активности установить поле Автоматическое уведомление
    Последующая логика описывается в **Переход 6

**Переход 6 (Найти Группу обслуживания по Ид)
Читаем объект Группы обслуживания, которуя раньше выудили из проверок, она находиться в "Ид. выбранной ГО"
Если "Тип" Группы обслуживания это "ВИП Платформа"
    Устанавливаем "Важность для выставления" как "Важно"
    *Добавить 2 линия поддержки на обр
    **Переход 7

Если установлены "Клиент ВИП" у ГО
    Устанавливаем "Важность для выставления" как "Важно"
    Если "Распределение ВИП" у ГО
        (Найти 3 линию поддержки для обращения (старший агент))
        Если нашли *Добавить 3 линия поддержки на обр и **Переход 7
    Далее *Добавить 2 линия поддержки на обр и **Переход 7

(Найти 1 линию поддержки для обращения)
Если "Приоритет" у родительской Активности "Высокий" - Установить "Важность для выставление" как "Важно"

Если найдена 1 линия поддержки - *Добавить 2 линия поддержки на обр и **Переход 7

Если не найдена 1 линия поддержки и установлен "OLP: Этап 1"
    установить в "Ид. выбранной ГО" значение "OLP:ГО Общая 1 линия поддержки"
    *Добавить 1 линия поддержки на обр
    **Переход 7

**Переход 7
Если не успешный ответ от ЕИС, то завершить БП
Если "OrderNumbCheck" от ЕИС не пустой
    (Собрать услуги для добавления)
    Запустить "OLP: Подпроцесс - Обновление услуг контакта v 3.0.1"
Завершить БП

*Выставить 1 линию поддержки
Изменить в объекте Обращение поля:
1. "Категория" на ту категорию, которая установлена в данном контексте 
(по умолчанию "Новая командировка/Изменение командировки")
2. "Группа" обслуживания на "OLP:ГО Общая 1 линия поддержки"
3. "Линия" поддержки на "OLP:ОР 1 линия поддержки"
4. "Важность" на "Не важно"
5. "Срочность" на "Не срочно"

*Найти ГО основную по графику работы 
Если "График работы" установлен как "Круглосуточный" сразу запоминаем ГО и идем дальше, пропуская шаги ниже 
Для каждого элемента Коллекции групп обслуживания проверяем следующие условия
1. Если дата обращение совпадает с выходным-праздничным днем, то переходим к следующей ГО
2. Если дата обращение совпадает с праздничным днем, который рабочий, то записать текущую ГО
3. Если дата обращение подходит под график работы текущей ГО, то используем эту конкрутную ГО
в противном случаем переходим на "Дежурную групп"

*Найти основную ГО для контакта по компаниям
Делаем запрос в бд по объекту "Группы обслуживания", добавляя следующие фильтры, 
если у Контакта не установлен параметр "ВИП платформа"
"Тип группы", указав выборку по "Основная группа"
"Почтовый ящик", указав выборку по "Почтовый ящик для регистрации обращений"
А так же сделать выборку "Компания" у контакта или "Холдинг" у Контрагент по параметру
"Компании" у объекта "Компании в группе обслуживания"
Если же у Контакта "ВИП платформа" установлена, то только добавить фильтр "Тип группы" на "ВИП Платформа"

*Добавить 1 линия поддержки на обр
Изменить Обращение в параметрах
1. "Линия поддержки" на "OLP:ОР 1 линия поддержки"
2. "Важность" на "Важность для выставления" (из контекста текущего разветвления)
3. "Срочность" на "Не срочно"
4. "Признак ВИП у Автора" на "Клиент ВИП" (из контекста текущего разветвления)
5. "Группа обслуживания" на "Ид. выбранной ГО"
6. "Компания" на "Компания" у Контакта
7. "Категория" на "Категория обращения" (из контекста текущего разветвления)
8. "Группа обслуживания (основная для очереди)" на "Группа обслуживания для выставления очереди" (из контекста текущего разветвления) 

*Добавить 2 линия поддержки на обр
Изменить Обращение в параметрах как в *Добавить 1 линия поддержки на обр, но
"Линия поддержки" на "OLP:ОР 2 линия поддержки"

*Добавить 3 линия поддержки на обр
Изменить Обращение в параметрах как в *Добавить 1 линия поддержки на обр, но
"Линия поддержки" на "OLP:ОР 2 линия поддержки"
1. "Линия поддержки" на "OLP:ОР 3 линия поддержки"
2. "Агент" на "Старший агент" 3-й линии
